<view class="wrap">
  <view class="card">
    <view class="title">球员登记</view>

    <view class="field">
      <text class="label">选择所在队伍</text>
  
      <picker
        mode="selector"
        range="{{teamNames}}"
        value="{{teamIndex}}"
        bindchange="onTeamChange"
      >
        <view class="picker">
          {{teamNames[teamIndex]}}
        </view>
      </picker>

      <view class="teamLogoRow">
        <image
          wx:if="{{teamLogos && teams[teamIndex] && teamLogos[teams[teamIndex].id]}}"
          class="teamLogo"
          src="{{teamLogos[teams[teamIndex].id]}}"
          mode="aspectFill"
        />
        <button size="mini" bindtap="onChangeTeamLogo">设置队徽</button>
      </view>
    </view>

    <view class="field">
      <text class="label">添加球员</text>
      <view class="row">
        <input class="input" placeholder="球员名" value="{{newName}}" bindinput="onNewName"/>
        <input class="input" placeholder="加点数" type="number" value="{{newLevel}}" bindinput="onNewLevel" />
        <picker mode="selector" range="{{starOptions}}" value="{{starIndex}}" bindchange="onStarChange">
          <view class="inputLike">星级：{{starOptions[starIndex]}} ⭐</view>
        </picker>
        <button size="mini" type="primary" bindtap="addOne">添加球员</button>
      </view>
    </view>

    <view class="field">
      <text class="label">转会费（可选，正数）</text>
      <input
        class="input"
        type="number"
        placeholder="例如 500，留空或 0 表示不记账"
        value="{{transferFee}}"
        bindinput="onTransferFeeInput"
      />
    </view>

    <view class="subTitle">球员列表</view>
    <view class="playerRow" wx:for="{{players}}" wx:key="_id" wx:for-item="p">
      <view class="left">
        <view class="playerHeader">
          <image
            wx:if="{{p.avatar}}"
            class="playerAvatar"
            src="{{p.avatar}}"
            mode="aspectFill"
          />
          <view class="playerInfo">
            <text class="sub">{{p.star}}⭐</text>
            <text class="name">{{p.name}} 点数：{{p.level || 0}}</text>
          </view>
        </view>

        <button
          class="avatarBtn"
          size="mini"
          data-id="{{p.playerId || p.id}}"
          bindtap="onChangePlayerAvatar"
        >设置头像</button>

        <view class="deltaRow">
          <input
            class="deltaInput"
            type="number"
            placeholder="+ 增加点数"
            value="{{deltaMap[p.playerId || p.id]}}"
            data-id="{{p.playerId || p.id}}"
            bindinput="onDeltaInput"
          />
          <button
            size="mini"
            data-id="{{p.playerId || p.id}}"
            bindtap="saveDelta"
          >保存</button>
        </view>
      </view>

      <view class="playerActions">
        <button
          size="mini"
          data-id="{{p.playerId || p.id}}"
          bindtap="onTransferPlayerTap"
        >转会</button>
        <button
          size="mini"
          type="warn"
          data-id="{{p.playerId || p.id}}"
          bindtap="removeOne"
        >删除</button>
      </view>
    </view>

    <view wx:if="{{players.length===0}}" class="empty">列表中无球员。</view>
  </view>

  <!-- 转会选择弹窗 -->
  <view wx:if="{{showTransferPicker}}" class="transferMask">
    <view class="transferPanel">
      <view class="transferTitle">选择转入队伍</view>
      <picker
        mode="selector"
        range="{{transferCandidates}}"
        range-key="name"
        value="{{transferCandidateIndex}}"
        bindchange="onTransferTargetChange"
      >
        <view class="picker">
          {{ transferCandidates[transferCandidateIndex].name || "请选择队伍" }}
        </view>
      </picker>

      <view class="transferBtns">
        <button size="mini" bindtap="onCancelTransfer">取消</button>
        <button size="mini" type="primary" bindtap="onConfirmTransfer">确认</button>
      </view>
    </view>
  </view>
</view>
